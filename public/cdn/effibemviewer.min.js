import*as THREE from"three";import{GLTFLoader}from"three/addons/loaders/GLTFLoader.js";import{OrbitControls}from"three/addons/controls/OrbitControls.js";class EffiBEMViewer{constructor(e,t={}){this.container="string"==typeof e?document.getElementById(e):e,this.options={includeGeometryDiagnostics:t.includeGeometryDiagnostics||!1},this.options.includeGeometryDiagnostics&&this.container.classList.add("include-diagnostics"),this.sceneObjects=[],this.objectEdges=new Map,this.backObjects=new Map,this.backToFront=new Map,this.selectedObject=null,this.originalMaterial=null,this.selectedBackWasVisible=!1,this.renderRequested=!1,this.mouseDownPos={x:0,y:0},this.infoPanel=this.container.querySelector(".info-panel"),this._initScene(),this._initControls(),this._initEventListeners()}_initScene(){this.scene=new THREE.Scene,this.scene.background=new THREE.Color(16119285),this.camera=new THREE.PerspectiveCamera(45,this.container.clientWidth/this.container.clientHeight,.1,5e3),this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.outputColorSpace=THREE.SRGBColorSpace,this.container.appendChild(this.renderer.domElement),this.orbitControls=new OrbitControls(this.camera,this.renderer.domElement),this.scene.add(new THREE.AmbientLight(8947848)),this.scene.add(new THREE.HemisphereLight(16777215,4473924,.6));const e=new THREE.DirectionalLight(16777215,.6);e.position.set(1,2,1),this.scene.add(e),this.selectedMaterial=new THREE.MeshStandardMaterial({color:16776960,emissive:4473856,side:THREE.DoubleSide})}_initControls(){const e=e=>this.container.querySelector(e);["showFloors","showWalls","showRoofs","showWindows","showDoors","showShading","showPartitions","showEdges"].forEach(t=>{e(`.${t}`)?.addEventListener("change",()=>this._updateVisibility())}),e(".showStory")?.addEventListener("change",()=>this._updateVisibility()),e(".renderBy")?.addEventListener("change",()=>this._updateRenderMode()),this.options.includeGeometryDiagnostics&&["showOnlyNonConvexSurfaces","showOnlyIncorrectlyOriented","showOnlyNonConvexSpaces","showOnlyNonEnclosedSpaces"].forEach(t=>{e(`.${t}`)?.addEventListener("change",()=>this._updateVisibility())})}_initEventListeners(){window.addEventListener("resize",()=>{this.camera.aspect=this.container.clientWidth/this.container.clientHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this._requestRender()}),this.orbitControls.addEventListener("change",()=>this._requestRender()),this.renderer.domElement.addEventListener("mousedown",e=>{this.mouseDownPos.x=e.clientX,this.mouseDownPos.y=e.clientY}),this.renderer.domElement.addEventListener("click",e=>this._onClick(e))}_onClick(e){const t=e.clientX-this.mouseDownPos.x,i=e.clientY-this.mouseDownPos.y;if(Math.abs(t)>5||Math.abs(i)>5)return;const o=this.renderer.domElement.getBoundingClientRect(),s=new THREE.Vector2((e.clientX-o.left)/o.width*2-1,-(e.clientY-o.top)/o.height*2+1),n=new THREE.Raycaster;n.setFromCamera(s,this.camera);const r=[...this.sceneObjects.filter(e=>e.visible),...[...this.backObjects.values()].filter(e=>e.visible)],a=n.intersectObjects(r);if(a.length>0){let t=a[0].object;this.backToFront.has(t)&&(t=this.backToFront.get(t)),this._selectObject(t,e.clientX,e.clientY)}else this._selectObject(null);this._requestRender()}_selectObject(e,t,i){if(this.selectedObject&&this.originalMaterial){this.selectedObject.material=this.originalMaterial;const e=this.backObjects.get(this.selectedObject);e&&(e.visible=this.selectedBackWasVisible)}if(e){this.selectedObject=e,this.originalMaterial=e.material,e.material=this.selectedMaterial;const o=this.backObjects.get(e);o&&(this.selectedBackWasVisible=o.visible,o.visible=!1),this._updateInfoPanel(e,t,i)}else this.selectedObject=null,this.originalMaterial=null,this.infoPanel.style.display="none"}_updateInfoPanel(e,t,i){const o=e=>this.container.querySelector(e),s=e.userData,n=o(".renderBy").value;o(".info-name").textContent=s.name||"Unknown";const r={surfaceType:"type",boundary:"boundary",construction:"construction",thermalZone:"thermalZone",spaceType:"spaceType",buildingStory:"buildingStory"}[n],a=(e,t)=>{const i=o(`.info-${e}-row`),s=o(`.info-${e}`);t?(s.textContent=t,i.style.display="block",i.classList.toggle("emphasized",e===r)):(i.style.display="none",i.classList.remove("emphasized"))};if(a("type",s.surfaceType),a("space",s.spaceName),a("spaceType",s.spaceTypeName),a("thermalZone",s.thermalZoneName),a("buildingStory",s.buildingStoryName),a("construction",s.constructionName),a("boundary",s.outsideBoundaryCondition),a("boundaryObject",s.outsideBoundaryConditionObjectName),a("sunExposure",s.sunExposure),a("windExposure",s.windExposure),this.options.includeGeometryDiagnostics){const e=(e,t)=>{const i=o(`.info-${e}-row`),s=o(`.info-${e}`);i&&void 0!==t?(s.innerHTML=`<span class="badge ${t?"badge-success":"badge-danger"}">${t}</span>`,i.style.display="block"):i&&(i.style.display="none")};e("convex",s.convex),e("correctlyOriented",s.correctlyOriented),e("spaceConvex",s.spaceConvex),e("spaceEnclosed",s.spaceEnclosed)}const c=this.container.getBoundingClientRect();let l=t-c.left+15,d=i-c.top-10;this.infoPanel.style.display="block";const h=this.infoPanel.getBoundingClientRect();l+h.width>this.container.clientWidth&&(l=t-c.left-h.width-15),d+h.height>this.container.clientHeight&&(d=this.container.clientHeight-h.height-10),d<10&&(d=10),this.infoPanel.style.left=l+"px",this.infoPanel.style.top=d+"px"}_updateVisibility(){const e=e=>this.container.querySelector(e),t=e(".showFloors")?.checked??!0,i=e(".showWalls")?.checked??!0,o=e(".showRoofs")?.checked??!0,s=e(".showWindows")?.checked??!0,n=e(".showDoors")?.checked??!0,r=e(".showShading")?.checked??!0,a=e(".showPartitions")?.checked??!0,c=e(".showEdges")?.checked??!0,l=e(".showStory")?.value||"",d=this.options.includeGeometryDiagnostics&&e(".showOnlyNonConvexSurfaces")?.checked,h=this.options.includeGeometryDiagnostics&&e(".showOnlyIncorrectlyOriented")?.checked,u=this.options.includeGeometryDiagnostics&&e(".showOnlyNonConvexSpaces")?.checked,E=this.options.includeGeometryDiagnostics&&e(".showOnlyNonEnclosedSpaces")?.checked;this.sceneObjects.forEach(e=>{const w=e.userData?.surfaceType||"",y=e.userData?.buildingStoryName||"";let p=!0;"Floor"===w?p=t:"Wall"===w?p=i:"RoofCeiling"===w?p=o:w.includes("Window")||w.includes("Skylight")||w.includes("TubularDaylight")||"GlassDoor"===w?p=s:w.includes("Door")?p=n:w.includes("Shading")?p=r:"InteriorPartitionSurface"===w&&(p=a),p&&l&&y!==l&&(p=!1),p&&d&&!1!==e.userData.convex&&(p=!1),p&&h&&!1!==e.userData.correctlyOriented&&(p=!1),p&&u&&!1!==e.userData.spaceConvex&&(p=!1),p&&E&&!1!==e.userData.spaceEnclosed&&(p=!1),e.visible=p;const m=this.objectEdges.get(e);m&&(m.visible=p&&c);const g=this.backObjects.get(e);g&&(g.visible=p)}),this._requestRender()}_updateRenderMode(){const e=this.container.querySelector(".renderBy").value;this.sceneObjects.forEach(t=>{const{colorExt:i,colorInt:o}=this._getColorsForObject(t,e);t.material.color.setHex(i);const s=this.backObjects.get(t);s&&s.material.color.setHex(o)}),this._requestRender()}_getColorsForObject(e,t){const i=e.userData;let o,s;switch(t){case"surfaceType":o=EffiBEMViewer.SURFACE_TYPE_COLORS[i.surfaceType]??13421772,s=EffiBEMViewer.SURFACE_TYPE_COLORS_INT[i.surfaceType]??15658734;break;case"boundary":const e=i.outsideBoundaryCondition||"Outdoors";let t=e;if("Outdoors"===e){const e="SunExposed"===i.sunExposure,o="WindExposed"===i.windExposure;e&&o?t="Outdoors_SunWind":e?t="Outdoors_Sun":o&&(t="Outdoors_Wind")}o=EffiBEMViewer.BOUNDARY_COLORS[t]??EffiBEMViewer.BOUNDARY_COLORS[e]??13421772,s=o;break;case"construction":o=this._getDynamicColor("construction",i.constructionName),s=o;break;case"thermalZone":o=this._getDynamicColor("thermalZone",i.thermalZoneName),s=o;break;case"spaceType":o=this._getDynamicColor("spaceType",i.spaceTypeName),s=o;break;case"buildingStory":o=this._getDynamicColor("buildingStory",i.buildingStoryName),s=o;break;default:o=13421772,s=15658734}return{colorExt:o,colorInt:s}}_getDynamicColor(e,t){this._dynamicColors||(this._dynamicColors={});const i=`${e}_${t}`;return this._dynamicColors[i]||(this._dynamicColors[i]=EffiBEMViewer._stringToColor(t)),this._dynamicColors[i]}static _stringToColor(e){if(!e)return 13421772;let t=0;for(let i=0;i<e.length;i++)t=e.charCodeAt(i)+((t<<5)-t);const i=Math.abs(t)%360;return new THREE.Color(`hsl(${i}, 65%, 55%)`).getHex()}_requestRender(){this.renderRequested||(this.renderRequested=!0,requestAnimationFrame(()=>this._render()))}_render(){this.renderRequested=!1,this.orbitControls.update(),this.renderer.render(this.scene,this.camera)}_loadGLTF(e){(new GLTFLoader).parse(JSON.stringify(e),"",t=>{this.scene.add(t.scene),this._processLoadedScene(t,e),this._requestRender()},e=>console.error("GLTF load error:",e))}_processLoadedScene(e,t){const i=this.container.querySelector(".renderBy").value,o=new THREE.LineBasicMaterial({color:0});e.scene.traverse(e=>{if(e.isMesh&&e.userData?.surfaceType){this.sceneObjects.push(e);const{colorExt:t,colorInt:s}=this._getColorsForObject(e,i);e.material=new THREE.MeshPhongMaterial({color:t,specular:2236962,shininess:30,side:THREE.FrontSide});const n=e.clone();n.material=new THREE.MeshPhongMaterial({color:s,specular:2236962,shininess:30,side:THREE.BackSide}),e.parent.add(n),this.backObjects.set(e,n),this.backToFront.set(n,e);const r=new THREE.EdgesGeometry(e.geometry),a=new THREE.LineSegments(r,o);a.position.copy(e.position),a.rotation.copy(e.rotation),a.scale.copy(e.scale),e.parent.add(a),this.objectEdges.set(e,a)}});const s=this.container.querySelector(".showStory");[...new Set(this.sceneObjects.map(e=>e.userData?.buildingStoryName).filter(Boolean))].sort().forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,s.appendChild(t)}),this._addAxes(t),this._positionCamera(t)}_addAxes(e){const t=e.scenes?.[0]?.extras?.boundingbox,i=t?4*t.lookAtR:10,o=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(i,0,0)]);this.scene.add(new THREE.Line(o,new THREE.LineBasicMaterial({color:16711680})));const s=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-i)]);this.scene.add(new THREE.Line(s,new THREE.LineBasicMaterial({color:65280})));const n=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(0,i,0)]);this.scene.add(new THREE.Line(n,new THREE.LineBasicMaterial({color:255})));const r=e.scenes?.[0]?.extras?.northAxis;if(r&&0!==r){const e=-r*Math.PI/180,t=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(-Math.sin(e)*i,0,-Math.cos(e)*i)]);this.scene.add(new THREE.Line(t,new THREE.LineBasicMaterial({color:16750899})))}}_positionCamera(e){const t=e.scenes?.[0]?.extras?.boundingbox;if(t){const e=new THREE.Vector3(t.lookAtX,t.lookAtZ,-t.lookAtY),i=2.5*t.lookAtR,o=-30*Math.PI/180,s=30*Math.PI/180;this.camera.position.set(i*Math.cos(o)*Math.cos(s)+e.x,i*Math.sin(s)+e.y,-i*Math.sin(o)*Math.cos(s)+e.z),this.orbitControls.target.copy(e),this.orbitControls.update()}}loadFromJSON(e){this._loadGLTF(e)}loadFromFile(e){return fetch(e).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>this.loadFromJSON(e))}loadFromFileObject(e){return new Promise((t,i)=>{const o=new FileReader;o.onload=e=>{try{const i=JSON.parse(e.target.result);this.loadFromJSON(i),t(i)}catch(e){i(new Error(`Failed to parse GLTF JSON: ${e.message}`))}},o.onerror=()=>i(new Error("Failed to read file")),o.readAsText(e)})}}EffiBEMViewer.SURFACE_TYPE_COLORS={Floor:8421504,Wall:13415014,RoofCeiling:10046540,Window:6730444,GlassDoor:6730444,Skylight:6730444,TubularDaylightDome:6730444,TubularDaylightDiffuser:6730444,Door:10061132,OverheadDoor:10061132,SiteShading:4947093,BuildingShading:7425177,SpaceShading:5009074,InteriorPartitionSurface:10402959,AirWall:6730444},EffiBEMViewer.SURFACE_TYPE_COLORS_INT={Floor:12566463,Wall:15459013,RoofCeiling:13276565,Window:12641003,GlassDoor:12641003,Skylight:12641003,TubularDaylightDome:12641003,TubularDaylightDiffuser:12641003,Door:13286549,OverheadDoor:13286549,SiteShading:12308956,BuildingShading:14207973,SpaceShading:12043744,InteriorPartitionSurface:14017231,AirWall:12641003},EffiBEMViewer.BOUNDARY_COLORS={Surface:39168,Adiabatic:16711680,Space:16711680,Outdoors:10734796,Outdoors_Sun:2673868,Outdoors_Wind:630690,Outdoors_SunWind:4487073,Ground:13416314,Foundation:7675514,OtherSideCoefficients:4144959,OtherSideConditionsModel:10027084},window.EffiBEMViewer=EffiBEMViewer,window.runFromJSON=function(e,t={}){const i=t.containerId||"viewer",o=new EffiBEMViewer(i,t);return o.loadFromJSON(e),o},window.runFromFile=function(e,t={}){const i=t.containerId||"viewer",o=new EffiBEMViewer(i,t);return o.loadFromFile(e),o},window.runFromFileObject=function(e,t={}){const i=t.containerId||"viewer",o=new EffiBEMViewer(i,t);return o.loadFromFileObject(e),o};export{EffiBEMViewer};